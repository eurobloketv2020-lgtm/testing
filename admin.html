<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel Admin | roberto marte mateo</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='50' fill='#1e3a8a'/><text x='50' y='50' text-anchor='middle' dy='0.35em' font-family='Playfair Display, serif' font-size='60' font-weight='bold' fill='white'>R</text></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Montserrat:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
  
  <style>
    body { font-family: 'Montserrat', sans-serif; }
    .font-display { font-family: 'Playfair Display', serif; }
    
    .loader-overlay {
      position: fixed; inset: 0; background: rgba(15, 43, 77, 0.85);
      backdrop-filter: blur(8px); display: none; align-items: center;
      justify-content: center; z-index: 9999;
    }
    .loader-spinner {
      width: 50px; height: 50px; border: 5px solid rgba(196, 154, 108, 0.2);
      border-bottom-color: #1e3a8a; border-radius: 50%;
      animation: rotation 1s linear infinite;
    }
    @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    #propiedadForm label {
      color: #000000 !important;
      font-weight: 700;
    }

    #propiedadForm input, 
    #propiedadForm textarea, 
    #propiedadForm select {
      color: #000000 !important;
      border: 1.5px solid #000000 !important;
      background-color: #ffffff !important;
    }

    #propiedadForm input::placeholder, 
    #propiedadForm textarea::placeholder {
      color: #4b5563 !important;
    }
    
    .tab-active {
      border-bottom: 3px solid #1e3a8a;
      color: #1e3a8a;
    }
  </style>
</head>
<body class="bg-gray-50 text-secondary">

  <div id="loadingOverlay" class="loader-overlay">
    <div class="flex flex-col items-center gap-4">
      <div class="loader-spinner"></div>
      <span class="text-white font-display italic tracking-widest text-lg">Procesando...</span>
    </div>
  </div>

  <div class="max-w-6xl mx-auto px-6 py-12">
    
    <div class="flex justify-between items-center mb-12">
      <div>
        <h1 class="font-display text-4xl font-bold text-secondary italic">Panel de Administración</h1>
        <p class="text-gray-500 mt-2">Gestiona tu catálogo inmobiliario</p>
      </div>
      <button onclick="irPagina('index.html')" class="p-3 rounded-full hover:bg-gray-200 transition-colors">
        <span class="material-symbols-outlined">close</span>
      </button>
    </div>

    <!-- Tabs -->
    <div class="flex gap-8 border-b border-gray-200 mb-8">
      <button onclick="cambiarTab('nueva')" id="tabNueva" class="tab-active pb-4 font-bold text-lg">Nueva Propiedad</button>
      <button onclick="cambiarTab('gestionar')" id="tabGestionar" class="pb-4 font-bold text-lg text-gray-500 hover:text-secondary">Gestionar Propiedades</button>
    </div>

    <!-- Tab: Nueva Propiedad -->
    <div id="contenidoNueva">
      <form id="propiedadForm" class="bg-white rounded-[2.5rem] p-8 md:p-12 shadow-2xl space-y-6">
        <input type="hidden" id="propiedadId" value="">
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="md:col-span-2">
            <label class="block text-sm uppercase tracking-widest mb-2">Título de la Propiedad *</label>
            <input type="text" name="titulo" required 
                   class="w-full p-4 rounded-2xl text-black border-black focus:ring-2 focus:ring-primary"
                   placeholder="Ej: Villa Moderna con Piscina">
          </div>

          <div>
            <label class="block text-sm uppercase tracking-widest mb-2">Ubicación *</label>
            <input type="text" name="ubicacion" required 
                   class="w-full p-4 rounded-2xl text-black border-black focus:ring-2 focus:ring-primary"
                   placeholder="Ej: Zona Premium">
          </div>

          <div>
            <label class="block text-sm uppercase tracking-widest mb-2">Precio (USD) *</label>
            <input type="number" name="precio" required 
                   class="w-full p-4 rounded-2xl text-black border-black focus:ring-2 focus:ring-primary"
                   placeholder="0.00">
          </div>
        </div>

        <div class="grid grid-cols-3 gap-4">
          <div>
            <label class="block text-xs font-bold uppercase mb-2">Habitaciones</label>
            <input type="number" name="habitaciones" value="1" class="w-full p-4 rounded-xl text-black border-black">
          </div>
          <div>
            <label class="block text-xs font-bold uppercase mb-2">Baños</label>
            <input type="number" name="banos" value="1" class="w-full p-4 rounded-xl text-black border-black">
          </div>
          <div>
            <label class="block text-xs font-bold uppercase mb-2">M² Const.</label>
            <input type="number" name="metros" value="0" class="w-full p-4 rounded-xl text-black border-black">
          </div>
        </div>

        <div>
          <label class="block text-sm uppercase tracking-widest mb-2">Descripción del Inmueble *</label>
          <textarea name="descripcion" required 
                    class="w-full p-4 rounded-2xl text-black border-black min-h-[150px] focus:ring-2 focus:ring-primary"
                    placeholder="Describe las características principales..."></textarea>
        </div>

        <div>
          <label class="block text-sm uppercase tracking-widest mb-2">Estado del Inmueble</label>
          <select name="estado" class="w-full p-4 rounded-2xl text-black border-black font-bold focus:ring-2 focus:ring-primary">
            <option value="EN_VENTA">Disponible</option>
            <option value="VENDIDA">Vendida</option>
          </select>
        </div>

        <div class="space-y-4">
          <label class="block text-sm uppercase tracking-widest mb-2 text-black font-bold">Fotos del Inmueble (Toque para subir)</label>
          
          <div class="grid grid-cols-1 gap-4">
            <input type="file" id="file1" accept="image/*" class="hidden" onchange="actualizarUIFoto(1)">
            <label for="file1" id="label1" 
                   class="w-full h-64 flex flex-col items-center justify-center bg-white border-2 border-black border-dashed rounded-[2rem] cursor-pointer overflow-hidden transition-all">
              <span class="material-symbols-outlined text-black text-4xl mb-2">add_a_photo</span>
              <span class="text-black font-bold text-sm">Foto Principal</span>
            </label>
            
            <div class="grid grid-cols-3 gap-4">
              <input type="file" id="file2" accept="image/*" class="hidden" onchange="actualizarUIFoto(2)">
              <label for="file2" id="label2" 
                     class="h-32 flex items-center justify-center bg-white border-2 border-black border-dashed rounded-2xl cursor-pointer overflow-hidden">
                <span class="material-symbols-outlined text-black">image</span>
              </label>

              <input type="file" id="file3" accept="image/*" class="hidden" onchange="actualizarUIFoto(3)">
              <label for="file3" id="label3" 
                     class="h-32 flex items-center justify-center bg-white border-2 border-black border-dashed rounded-2xl cursor-pointer overflow-hidden">
                <span class="material-symbols-outlined text-black">image</span>
              </label>

              <input type="file" id="file4" accept="image/*" class="hidden" onchange="actualizarUIFoto(4)">
              <label for="file4" id="label4" 
                     class="h-32 flex items-center justify-center bg-white border-2 border-black border-dashed rounded-2xl cursor-pointer overflow-hidden">
                <span class="material-symbols-outlined text-black">image</span>
              </label>
            </div>
          </div>
        </div>

        <button type="submit" id="btnPublicar" 
                class="w-full bg-[#1e3a8a] text-white py-6 rounded-[2rem] font-bold text-xl shadow-2xl hover:opacity-90 active:scale-[0.98] transition-all flex items-center justify-center gap-3 mt-8" style="background-color: #1e3a8a;">
          <span id="textoBtn">Publicar Inmueble</span>
        </button>
      </form>
    </div>

    <!-- Tab: Gestionar Propiedades -->
    <div id="contenidoGestionar" class="hidden">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="listaPropiedades">
        <p class="text-gray-400">Cargando propiedades...</p>
      </div>
    </div>

  </div>

  <!-- Modal Éxito -->
  <div id="successAdminModal" class="fixed inset-0 z-[100] hidden items-center justify-center p-4">
    <div class="absolute inset-0 bg-secondary/80 backdrop-blur-md"></div>
    <div id="successAdminContent" class="relative bg-white w-full max-w-sm rounded-[2.5rem] p-10 text-center shadow-2xl transform transition-all scale-95 opacity-0">
      <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
        <span class="material-symbols-outlined text-green-600 text-5xl">check_circle</span>
      </div>
      <h3 class="font-display text-2xl font-bold mb-2 italic" id="modalTitulo">¡Acción completada!</h3>
      <p class="text-gray-500 text-sm mb-8" id="modalMensaje">Operación exitosa.</p>
      <div class="flex flex-col gap-3">
        <button onclick="cerrarModalExito()" class="w-full text-white py-4 rounded-2xl font-bold" style="background-color: #1e3a8a;">
          Entendido
        </button>
      </div>
    </div>
  </div>

  <!-- Modal Confirmar Eliminación -->
  <div id="confirmarModal" class="fixed inset-0 z-[100] hidden items-center justify-center p-4">
    <div class="absolute inset-0 bg-secondary/80 backdrop-blur-md"></div>
    <div class="relative bg-white w-full max-w-sm rounded-[2.5rem] p-10 text-center shadow-2xl">
      <div class="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-6">
        <span class="material-symbols-outlined text-red-600 text-5xl">delete</span>
      </div>
      <h3 class="font-display text-2xl font-bold mb-2">¿Eliminar propiedad?</h3>
      <p class="text-gray-500 text-sm mb-8">Esta acción no se puede deshacer.</p>
      <div class="flex gap-3">
        <button onclick="cerrarConfirmar()" class="flex-1 py-3 border-2 border-gray-300 rounded-xl font-bold hover:bg-gray-50">
          Cancelar
        </button>
        <button onclick="confirmarEliminar()" class="flex-1 py-3 bg-red-600 text-white rounded-xl font-bold hover:bg-red-700">
          Eliminar
        </button>
      </div>
    </div>
  </div>

<script>
  const API_URL = 'https://script.google.com/macros/s/AKfycbwf799bHyAJahpyLw8_pP0B4iUqkbhGgWSME-svZlI7QbgulCXYD5V7p0-v5LDWWqVm/exec';
  let propiedadAEliminar = null;
  let modoEdicion = false;
  let imagenesActuales = {};

  function irPagina(p) {
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) overlay.style.display = 'flex';
    window.location.href = p;
  }

function cambiarTab(tab) {
  document.getElementById('tabNueva').classList.remove('tab-active', 'text-gray-500');
  document.getElementById('tabGestionar').classList.remove('tab-active', 'text-gray-500');
  
  if (tab === 'nueva') {
    document.getElementById('tabNueva').classList.add('tab-active');
    document.getElementById('tabGestionar').classList.add('text-gray-500');
    document.getElementById('contenidoNueva').classList.remove('hidden');
    document.getElementById('contenidoGestionar').classList.add('hidden');
    if (!modoEdicion) {
      limpiarFormulario();
    }
  } else {
    document.getElementById('tabGestionar').classList.add('tab-active');
    document.getElementById('tabNueva').classList.add('text-gray-500');
    document.getElementById('contenidoNueva').classList.add('hidden');
    document.getElementById('contenidoGestionar').classList.remove('hidden');
    cargarPropiedades();
  }
}

  function cargarPropiedades() {
    fetch(`${API_URL}?path=propiedades/todas`)
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          mostrarPropiedades(data.data);
        }
      });
  }

  function mostrarPropiedades(props) {
    const container = document.getElementById('listaPropiedades');
    if (!props || props.length === 0) {
      container.innerHTML = '<p class="text-gray-500">No hay propiedades registradas.</p>';
      return;
    }
    
    container.innerHTML = props.map(p => `
      <div class="bg-white rounded-2xl overflow-hidden shadow-lg border border-gray-200">
        <img src="${p.imagen1 || 'https://via.placeholder.com/400x300'}" class="w-full h-48 object-cover" />
        <div class="p-4">
          <h3 class="font-bold text-lg mb-2">${p.titulo}</h3>
          <p class="text-sm text-gray-600 mb-2">${p.ubicacion}</p>
          <p class="font-bold text-xl mb-4" style="color: #1e3a8a;">$${parseFloat(p.precio).toLocaleString()}</p>
          <div class="flex gap-2">
            <button onclick="editarPropiedad(${p.id})" class="flex-1 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 flex items-center justify-center gap-1">
              <span class="material-symbols-outlined text-sm">edit</span> Editar
            </button>
            <button onclick="abrirConfirmar(${p.id})" class="flex-1 py-2 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 flex items-center justify-center gap-1">
              <span class="material-symbols-outlined text-sm">delete</span> Eliminar
            </button>
          </div>
        </div>
      </div>
    `).join('');
  }

function editarPropiedad(id) {
  const overlay = document.getElementById('loadingOverlay');
  overlay.style.display = 'flex';
  
  fetch(`${API_URL}?path=propiedades/detalle&id=${id}`)
    .then(r => r.json())
    .then(data => {
      overlay.style.display = 'none';
      
      if (data.success && data.data) {
        const p = data.data;
        modoEdicion = true;
        
        document.getElementById('propiedadId').value = id;
        document.querySelector('[name="titulo"]').value = p.titulo;
        document.querySelector('[name="ubicacion"]').value = p.ubicacion;
        document.querySelector('[name="precio"]').value = p.precio;
        document.querySelector('[name="habitaciones"]').value = p.habitaciones;
        document.querySelector('[name="banos"]').value = p.banos;
        document.querySelector('[name="metros"]').value = p.metrosCuadrados;
        document.querySelector('[name="descripcion"]').value = p.descripcion;
        document.querySelector('[name="estado"]').value = p.estado;
        
        imagenesActuales = {
          imagen1: p.imagen1 || '',
          imagen2: p.imagen2 || '',
          imagen3: p.imagen3 || '',
          imagen4: p.imagen4 || ''
        };
        
        [1, 2, 3, 4].forEach(i => {
          const img = p['imagen' + i];
          if (img) {
            const label = document.getElementById('label' + i);
            label.innerHTML = `<img src="${img}" class="w-full h-full object-cover rounded-2xl border-2 border-black">`;
            label.style.padding = "0";
            label.style.borderStyle = "solid";
            label.style.borderColor = "#000000";
          }
        });
        
        document.getElementById('textoBtn').textContent = 'Actualizar Inmueble';
        cambiarTab('nueva');
      } else {
        alert('Error al cargar la propiedad');
      }
    })
    .catch(error => {
      overlay.style.display = 'none';
      alert('Error de conexión: ' + error.message);
    });
}

  function abrirConfirmar(id) {
    propiedadAEliminar = id;
    document.getElementById('confirmarModal').classList.remove('hidden');
    document.getElementById('confirmarModal').classList.add('flex');
  }

  function cerrarConfirmar() {
    propiedadAEliminar = null;
    document.getElementById('confirmarModal').classList.add('hidden');
    document.getElementById('confirmarModal').classList.remove('flex');
  }

  function confirmarEliminar() {
    if (!propiedadAEliminar) return;
    
    const overlay = document.getElementById('loadingOverlay');
    overlay.style.display = 'flex';
    
    fetch(API_URL, {
      method: 'POST',
      body: JSON.stringify({
        action: 'eliminar_propiedad',
        id: propiedadAEliminar
      })
    })
    .then(r => r.json())
    .then(data => {
      overlay.style.display = 'none';
      cerrarConfirmar();
      if (data.success) {
        mostrarModalExito('¡Eliminada!', 'La propiedad ha sido eliminada.');
        cargarPropiedades();
      }
    });
  }

  function limpiarFormulario() {
    modoEdicion = false;
    imagenesActuales = {};
    document.getElementById('propiedadId').value = '';
    document.getElementById('propiedadForm').reset();
    document.getElementById('textoBtn').textContent = 'Publicar Inmueble';
    
    for (let i = 1; i <= 4; i++) {
      const label = document.getElementById('label' + i);
      label.innerHTML = i === 1 
        ? '<span class="material-symbols-outlined text-black text-4xl mb-2">add_a_photo</span><span class="text-black font-bold text-sm">Foto Principal</span>'
        : '<span class="material-symbols-outlined text-black">image</span>';
      label.style.padding = "";
      label.style.borderStyle = "dashed";
    }
  }

  function actualizarUIFoto(n) {
    const input = document.getElementById('file' + n);
    const label = document.getElementById('label' + n);
    
    if (input.files && input.files[0]) {
      const reader = new FileReader();
      reader.onload = function(e) {
        label.innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover rounded-2xl border-2 border-black shadow-sm">`;
        label.style.padding = "0";
        label.style.borderStyle = "solid";
        label.style.borderColor = "#000000";
      };
      reader.readAsDataURL(input.files[0]);
    }
  }

  function mostrarModalExito(titulo, mensaje) {
    document.getElementById('modalTitulo').textContent = titulo;
    document.getElementById('modalMensaje').textContent = mensaje;
    const modal = document.getElementById('successAdminModal');
    const content = document.getElementById('successAdminContent');
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    setTimeout(() => {
      content.classList.remove('scale-95', 'opacity-0');
      content.classList.add('scale-100', 'opacity-100');
    }, 10);
  }

  function cerrarModalExito() {
    const content = document.getElementById('successAdminContent');
    const modal = document.getElementById('successAdminModal');
    content.classList.add('scale-95', 'opacity-0');
    setTimeout(() => {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      if (modoEdicion) {
        cambiarTab('gestionar');
      } else {
        location.reload();
      }
    }, 300);
  }

  const comprimirImagen = (file) => {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = (event) => {
        const img = new Image();
        img.src = event.target.result;
        img.onload = () => {
          const canvas = document.createElement('canvas');
          const MAX_SIZE = 1200;
          let width = img.width;
          let height = img.height;

          if (width > height) {
            if (width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE; }
          } else {
            if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; }
          }

          canvas.width = width;
          canvas.height = height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, width, height);
          
          resolve(canvas.toDataURL('image/jpeg', 0.75));
        };
      };
    });
  };

  document.getElementById('propiedadForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const btn = document.getElementById('btnPublicar');
    const textoBtn = document.getElementById('textoBtn');
    const overlay = document.getElementById('loadingOverlay');
    const propId = document.getElementById('propiedadId').value;

    btn.disabled = true;
    btn.style.opacity = "0.7";
    textoBtn.innerText = modoEdicion ? "Actualizando..." : "Optimizando imágenes...";
    if (overlay) overlay.style.display = 'flex';

    try {
      const payload = {
        titulo: this.titulo.value,
        descripcion: this.descripcion.value,
        ubicacion: this.ubicacion.value,
        precio: parseFloat(this.precio.value) || 0,
        habitaciones: parseInt(this.habitaciones.value) || 0,
        banos: parseInt(this.banos.value) || 0,
        metros: parseInt(this.metros.value) || 0,
        estado: this.estado.value,
        tipo: "Casa",
        destacada: false
      };

      if (modoEdicion) {
        payload.imagen1 = imagenesActuales.imagen1 || '';
        payload.imagen2 = imagenesActuales.imagen2 || '';
        payload.imagen3 = imagenesActuales.imagen3 || '';
        payload.imagen4 = imagenesActuales.imagen4 || '';
      }

      const promesasSubida = [];
      
      for (let i = 1; i <= 4; i++) {
        const input = document.getElementById('file' + i);
        if (input && input.files.length > 0) {
          const proceso = (async (index) => {
            const b64 = await comprimirImagen(input.files[0]);
            const response = await fetch(API_URL, {
              method: 'POST',
              body: JSON.stringify({
                action: 'subir_imagen',
                base64Data: b64,
                nombreArchivo: `Prop_${Date.now()}_${index}`
              })
            });
            const data = await response.json();
            return { index, url: data.data.url };
          })(i);
          promesasSubida.push(proceso);
        }
      }

      if (promesasSubida.length > 0) {
        textoBtn.innerText = "Subiendo imágenes...";
        const resultados = await Promise.all(promesasSubida);
        resultados.forEach(res => {
          payload['imagen' + res.index] = res.url;
        });
      }

      textoBtn.innerText = modoEdicion ? "Guardando cambios..." : "Guardando propiedad...";
      
      const action = modoEdicion ? 'actualizar_propiedad' : 'crear_propiedad';
      const body = modoEdicion 
        ? { action, id: propId, payload }
        : { action, payload };
      
      const response = await fetch(API_URL, {
        method: 'POST',
        body: JSON.stringify(body)
      });
      
      const data = await response.json();
      
      if (data.success) {
        if (overlay) overlay.style.display = 'none';
        mostrarModalExito(
          modoEdicion ? '¡Actualizada!' : '¡Publicado con éxito!',
          modoEdicion ? 'Los cambios han sido guardados.' : 'El inmueble ya está en el catálogo.'
        );
      } else {
        throw new Error(data.error || 'Error desconocido');
      }

    } catch (err) {
      if (overlay) overlay.style.display = 'none';
      btn.disabled = false;
      btn.style.opacity = "1";
      textoBtn.innerText = "Reintentar";
      alert("Error: " + err.message);
    }
  });
</script>
</body>

</html>
